<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mukemen Image Studio</title>
  <meta name="description" content="Text-to-Image & Image Editing via OpenRouter" />
  <style>
    body { font-family: Arial, sans-serif; background:#0b0c10; color:#fff; margin:0; }
    .wrap { max-width:900px; margin:auto; padding:20px; }
    .card { background:#15171c; padding:20px; border-radius:16px; margin-top:16px; }
    textarea, input, select { width:100%; padding:10px; margin:6px 0; border-radius:8px; border:none; }
    button { padding:12px 18px; border:none; border-radius:10px; cursor:pointer; background:linear-gradient(135deg,#22d3ee,#4fd1c5); color:#000; font-weight:bold; }
    .preview img { max-width:100%; border-radius:12px; margin-top:12px; }
    .footer { margin-top:20px; font-size:12px; color:#aaa; text-align:center; }
    .muted { color:#b9c2cf; font-size:12px }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mukemen Image Studio</h1>
    <div class="card">
      <label>Prompt (deskripsi gambar)</label>
      <textarea id="prompt" placeholder="Contoh: ‘Espresso Fabaro Kopi, lighting dramatis, 8K’"></textarea>

      <label>Mode</label>
      <select id="mode">
        <option value="generate">Text → Image</option>
        <option value="edit">Edit Gambar (upload gambar)</option>
      </select>

      <label>Model</label>
      <select id="model">
        <!-- Gratis/preview (sering gagal mengembalikan image) -->
        <option value="google/gemini-2.5-flash-image-preview:free">Gemini 2.5 Flash Image (free/preview)</option>
        <!-- Lebih stabil (biasanya butuh kredit) -->
        <option value="stabilityai/stable-diffusion-3.5-large">Stable Diffusion 3.5 Large</option>
        <option value="stabilityai/stable-diffusion-3.5-medium">Stable Diffusion 3.5 Medium</option>
        <option value="openai/gpt-image-1">OpenAI GPT-Image-1</option>
      </select>
      <div class="muted">Catatan: model gratis bisa gagal/limit. Jika error, coba model lain di atas.</div>

      <label>Upload Gambar (opsional untuk edit)</label>
      <input id="file" type="file" accept="image/*" />

      <button id="go">Buat Gambar</button>
    </div>

    <div class="card">
      <p id="status">Status: siap</p>
      <div class="preview" id="out"></div>
    </div>

    <div class="footer">
      © 2025 Mukemen.ai • Set environment <code>OPENROUTER_API_KEY</code> di Vercel
    </div>
  </div>

  <script>
    const goEl = document.getElementById('go');
    const outEl = document.getElementById('out');
    const statusEl = document.getElementById('status');

    async function readAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    goEl.addEventListener('click', async () => {
      const prompt = document.getElementById('prompt').value.trim();
      const mode = document.getElementById('mode').value;
      const model = document.getElementById('model').value;
      const file = document.getElementById('file').files[0];

      if (!prompt) { alert("Masukkan prompt dulu"); return; }

      statusEl.textContent = "Mengirim ke API...";
      outEl.innerHTML = "";

      let imageDataUrl = null;
      if (mode === "edit" && file) {
        imageDataUrl = await readAsDataURL(file);
      }

      const resp = await fetch('/api/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, mode, imageDataUrl, model })
      });

      const data = await resp.json();
      if (!resp.ok) {
        statusEl.textContent = "Gagal: " + (data.error || "error");
        console.log('RAW ERROR:', data.raw || data);
        return;
      }

      statusEl.textContent = "Sukses! " + data.images.length + " gambar";
      data.images.forEach(url => {
        const img = document.createElement('img');
        img.src = url;
        outEl.appendChild(img);
      });
    });
  </script>
</body>
</html>
