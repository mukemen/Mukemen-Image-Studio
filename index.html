<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mukemen Image Studio</title>

  <!-- Deskripsi & Preview -->
  <meta name="description" content="Text-to-Image & Edit Gambar — Powered by FABARO GROUP" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Mukemen Image Studio" />
  <meta property="og:description" content="Text-to-Image & Edit Gambar — Powered by FABARO GROUP" />
  <meta property="og:image" content="/og-image.png" />
  <meta property="og:url" content="https://mukemen-image-studio.vercel.app/" />
  <meta property="og:site_name" content="Mukemen Image Studio" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Mukemen Image Studio" />
  <meta name="twitter:description" content="Text-to-Image & Edit Gambar — Powered by FABARO GROUP" />
  <meta name="twitter:image" content="/og-image.png" />

  <!-- Icons / Manifest (PWA opsional) -->
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png" />
  <link rel="icon" type="image/png" sizes="64x64" href="/favicon-64.png" />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <meta name="theme-color" content="#06b6d4" />

  <!-- Tailwind + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: ['class'],
      theme: {
        extend: {
          fontFamily: { inter: ['Inter','ui-sans-serif','system-ui'] },
          colors: { brand: { 400:'#22d3ee',500:'#06b6d4',600:'#0891b2' } },
          boxShadow: { glass: '0 8px 30px rgba(0,0,0,.35)' }
        }
      }
    }
  </script>
  <style>
    body { font-family: Inter, system-ui, Arial, sans-serif; }
    .glass { backdrop-filter: blur(12px); background: rgba(17,25,40,.6); }
    .gradient-bg {
      background:
        radial-gradient(1200px 600px at -10% -20%, rgba(34,211,238,.25), transparent 60%),
        radial-gradient(1000px 500px at 120% 10%, rgba(6,182,212,.25), transparent 55%),
        linear-gradient(180deg,#0a0d12 0%,#0b0e14 60%,#0c1017 100%);
    }
    .light .glass { background: rgba(255,255,255,.65); }
    .light.gradient-bg {
      background:
        radial-gradient(900px 450px at -10% -20%, rgba(2,132,199,.15), transparent 60%),
        radial-gradient(800px 400px at 120% 10%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg,#f6f7fb 0%,#f2f5fb 100%);
    }
  </style>
</head>
<body class="gradient-bg min-h-screen text-slate-100">
  <!-- Header -->
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/logo_icon_256.png" alt="FABARO GROUP"
             class="w-11 h-11 rounded-2xl shadow-lg object-contain bg-white/5 p-1" />
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">Mukemen Image Studio</h1>
          <p class="text-slate-400 text-sm md:text-[15px]">Powered by <b>FABARO GROUP</b></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="installBtn" class="hidden text-xs px-3 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20">Install Aplikasi</button>
        <button id="themeBtn"   class="text-xs px-3 py-2 rounded-lg bg-white/10 border border-white/10 hover:bg-white/20">Mode Terang</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 pb-16">
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Controls -->
      <section class="glass rounded-2xl p-5 md:p-6 shadow-glass border border-white/10">
        <label class="text-sm opacity-90">Prompt (deskripsi gambar)</label>
        <textarea id="prompt" class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3 outline-none focus:ring-2 focus:ring-brand-400/60"
          placeholder="Contoh: Espresso Fabaro Kopi, gelas kaca berembun, lighting dramatis, ultra realistis, 8K"></textarea>

        <div class="flex flex-wrap gap-2 mt-3">
          <button class="qp px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs hover:bg-white/10">produk kopi premium, low-key lighting, studio background hitam, 8K</button>
          <button class="qp px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs hover:bg-white/10">logo Fabaro Kopi timbul, emboss gold, latar gelap elegan</button>
          <button class="qp px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs hover:bg-white/10">poster UMKM modern, neon rim light, high contrast</button>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <!-- Engine -->
          <div>
            <label class="text-sm opacity-90">Engine</label>
            <select id="engine" class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
              <option value="local">Local (WebGPU — GRATIS)</option>
              <option value="cloud" selected>Cloud (OpenRouter)</option>
            </select>
          </div>
          <!-- Mode -->
          <div>
            <label class="text-sm opacity-90">Mode</label>
            <select id="mode" class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
              <option value="generate">Text → Image</option>
              <option value="edit">Edit Gambar (upload)</option>
            </select>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <!-- (2a) MODEL (Cloud) -->
          <div>
            <label class="text-sm opacity-90">Model (Cloud)</label>
            <select id="model"
              class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
              <option value="auto-free">Auto (Gratis)</option>
              <option value="google/gemini-2.5-flash-image-preview:free" selected>
                Gemini 2.5 Flash Image (free)
              </option>
              <option value="google/gemini-2.5-flash-image-preview">
                Gemini 2.5 Flash Image (paid)
              </option>
            </select>
          </div>
          <!-- Rasio -->
          <div>
            <label class="text-sm opacity-90">Rasio</label>
            <select id="ratio" class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
              <option value="1:1">1:1 (Kotak)</option>
              <option value="16:9">16:9 (Landscape)</option>
              <option value="9:16">9:16 (Portrait)</option>
              <option value="4:5">4:5 (IG Post)</option>
              <option value="3:2">3:2</option>
              <option value="custom">Custom</option>
            </select>
          </div>
        </div>

        <!-- Ukuran + Upload -->
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label class="text-sm opacity-90">Ukuran (sisi panjang, px)</label>
            <div class="flex gap-2 mt-2">
              <input id="longEdge" type="number" min="512" step="64" value="1024"
                class="w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
              <div class="hidden md:flex gap-2">
                <button class="preset px-3 py-2 text-xs rounded-lg bg-white/10 hover:bg-white/20" data-v="768">768</button>
                <button class="preset px-3 py-2 text-xs rounded-lg bg-white/10 hover:bg-white/20" data-v="1024">1024</button>
                <button class="preset px-3 py-2 text-xs rounded-lg bg-white/10 hover:bg-white/20" data-v="1536">1536</button>
              </div>
            </div>
          </div>
          <div>
            <label class="text-sm opacity-90">Upload Gambar (untuk Edit)</label>
            <div id="dropzone" class="mt-2 rounded-xl border border-dashed border-white/15 bg-slate-900/40 p-4 grid place-items-center text-center cursor-pointer hover:bg-slate-900/55 transition">
              <input id="file" type="file" accept="image/*" class="hidden" />
              <div class="text-slate-300/80 text-sm">
                <div class="font-semibold mb-1">Tarik & letakkan gambar di sini</div>
                atau <span class="underline decoration-dotted">klik untuk memilih file</span>
                <div id="fileName" class="mt-1 text-xs opacity-70"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Custom width/height -->
        <div id="customWH" class="grid md:grid-cols-2 gap-4 mt-4 hidden">
          <div>
            <label class="text-sm opacity-90">Lebar (px)</label>
            <input id="width" type="number" min="256" step="8" value="1024"
              class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
          </div>
          <div>
            <label class="text-sm opacity-90">Tinggi (px)</label>
            <input id="height" type="number" min="256" step="8" value="1024"
              class="mt-2 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
          </div>
        </div>

        <p id="calcOut" class="text-xs opacity-70 mt-2">Output ~ <b>1024×1024</b> (otomatis kelipatan 8)</p>

        <div class="flex items-center gap-3 mt-5">
          <button id="go" class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-br from-brand-400 to-brand-600 text-slate-900 font-bold px-5 py-3 shadow-lg hover:shadow-brand-500/30">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l8 8-8 8-1.41-1.41L16.17 12 10.59 6.41 12 5z"/></svg>
            Buat Gambar
          </button>
          <span id="status" class="text-sm opacity-80">Siap.</span>
        </div>
      </section>

      <!-- Preview -->
      <section class="glass rounded-2xl p-5 md:p-6 shadow-glass border border-white/10">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Hasil</h2>
          <button id="clear" class="text-xs px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">Bersihkan</button>
        </div>
        <div id="loader" class="hidden py-8 grid place-items-center">
          <div class="w-12 h-12 border-4 border-white/20 border-t-brand-400 rounded-full animate-spin"></div>
          <p class="opacity-80 text-sm mt-3">Memproses...</p>
        </div>
        <div id="out" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
      </section>
    </div>

    <p class="text-center text-[12px] opacity-60 mt-6">© 2025 Mukemen.ai</p>
  </main>

  <!-- App JS -->
  <script>
    const $ = (id)=>document.getElementById(id);

    const promptEl = $('prompt'), modeEl = $('mode'), modelEl = $('model'), engineEl = $('engine');
    const ratioEl = $('ratio'), longEdgeEl = $('longEdge'), widthEl = $('width'), heightEl = $('height'), customWH = $('customWH');
    const fileEl = $('file'), fileNameEl = $('fileName'), drop = $('dropzone');
    const goBtn = $('go'), statusEl = $('status'), outEl = $('out'), loader = $('loader');
    const clearBtn = $('clear'), themeBtn = $('themeBtn'), installBtn = $('installBtn');
    const calcOut = $('calcOut');

    // Theme toggle
    let light = false;
    themeBtn.addEventListener('click', ()=>{
      light = !light;
      document.body.classList.toggle('light', light);
      document.body.classList.toggle('text-slate-800', light);
      document.body.classList.toggle('text-slate-100', !light);
      themeBtn.textContent = light ? 'Mode Gelap' : 'Mode Terang';
    });

    // Quick prompts
    document.querySelectorAll('.qp').forEach(el=> el.addEventListener('click', ()=>{ promptEl.value = el.textContent; }));

    // Preset sizes
    document.querySelectorAll('.preset').forEach(btn=>{
      btn.addEventListener('click', ()=>{ longEdgeEl.value = btn.dataset.v; updateDims(); });
    });

    // Dropzone
    drop.addEventListener('click', ()=> fileEl.click());
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('ring-2','ring-brand-400/60'); });
    drop.addEventListener('dragleave', ()=> drop.classList.remove('ring-2','ring-brand-400/60'));
    drop.addEventListener('drop', e=>{
      e.preventDefault(); drop.classList.remove('ring-2','ring-brand-400/60');
      if (e.dataTransfer.files?.[0]) { fileEl.files = e.dataTransfer.files; fileNameEl.textContent = e.dataTransfer.files[0].name; }
    });
    fileEl.addEventListener('change', ()=> fileNameEl.textContent = fileEl.files?.[0]?.name || '');

    clearBtn.addEventListener('click', ()=>{ outEl.innerHTML=''; statusEl.textContent='Siap.'; });

    function round8(x){ return Math.max(256, Math.round((Number(x)||0)/8)*8); }
    function parseRatio(r){ const [a,b]=r.split(':').map(Number); return {a,b}; }

    function updateDims(){
      const r = ratioEl.value;
      const L = Math.max(256, Number(longEdgeEl.value)||1024);
      if (r === 'custom') {
        customWH.classList.remove('hidden');
        calcOut.innerHTML = `Output ~ <b>${round8(widthEl.value)}×${round8(heightEl.value)}</b>`;
        return;
      }
      customWH.classList.add('hidden');
      const {a,b} = parseRatio(r);
      let w, h;
      if (a>=b){ w=L; h=Math.round(L * b / a); } else { h=L; w=Math.round(L * a / b); }
      w=round8(w); h=round8(h);
      widthEl.value=w; heightEl.value=h;
      calcOut.innerHTML = `Output ~ <b>${w}×${h}</b> (rasio ${r})`;
    }
    ratioEl.addEventListener('change', updateDims);
    longEdgeEl.addEventListener('input', updateDims);
    widthEl.addEventListener('input', ()=> calcOut.innerHTML = `Output ~ <b>${round8(widthEl.value)}×${round8(heightEl.value)}</b>`);
    heightEl.addEventListener('input', ()=> calcOut.innerHTML = `Output ~ <b>${round8(widthEl.value)}×${round8(heightEl.value)}</b>`);
    updateDims();

    function setLoading(v){ loader.classList.toggle('hidden', !v); goBtn.disabled = v; goBtn.classList.toggle('opacity-60', v); }

    async function readAsDataURL(file) {
      const dataUrl = await new Promise((resolve, reject)=>{
        const r = new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
      });
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>{
          const max = 1536, s = Math.min(1, max / Math.max(img.width, img.height));
          if (s >= 1) return resolve(dataUrl);
          const c = document.createElement('canvas'); c.width = img.width*s; c.height = img.height*s;
          const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
          resolve(c.toDataURL('image/jpeg', 0.92));
        }; img.src = dataUrl;
      });
    }

    // PWA (opsional)
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.classList.remove('hidden'); });
    installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.classList.add('hidden'); });

    // Sinkron UI engine (disable edit saat local)
    function syncEngineUI(){
      const eng = engineEl.value;
      modeEl.querySelector('option[value="edit"]').disabled = (eng === 'local');
      if (eng === 'local' && modeEl.value === 'edit') modeEl.value = 'generate';
      modelEl.disabled = (eng === 'local'); // model hanya untuk cloud
    }
    engineEl.addEventListener('change', syncEngineUI); syncEngineUI();

    // ===== (2b) BUAT GAMBAR — fallback Local → Cloud =====
    goBtn.addEventListener('click', async ()=>{
      const prompt = promptEl.value.trim();
      const mode   = modeEl.value;
      const model  = modelEl.value;
      const engine = engineEl.value;

      const ratio  = ratioEl.value;
      const width  = round8(widthEl.value);
      const height = round8(heightEl.value);
      const file   = fileEl.files?.[0];

      if (!prompt) { alert('Masukkan prompt dulu.'); return; }
      if (engine === 'local' && mode === 'edit') { alert('Edit belum didukung di mode Lokal. Pilih Cloud.'); return; }
      if (engine === 'cloud' && mode === 'edit' && !file) { alert('Pilih gambar untuk mode Edit.'); return; }

      setLoading(true);
      outEl.innerHTML = '';

      // Helper: panggil backend Cloud (OpenRouter)
      const runCloud = async ()=>{
        statusEl.textContent = 'Mengirim ke API (Cloud)…';
        let imageDataUrl = null;
        if (mode === 'edit' && file) imageDataUrl = await readAsDataURL(file);
        const resp = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, mode, imageDataUrl, model, ratio, width, height })
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Cloud error');
        return data.images || [];
      };

      try {
        let urls = [];

        if (engine === 'local') {
          // coba Local (WebGPU) → jika gagal, otomatis pindah ke Cloud (Gratis)
          try {
            statusEl.textContent = 'Menjalankan lokal (WebGPU)…';
            const safeW = Math.min(768, width);
            const safeH = Math.min(768, height);
            const Local = await import('/local.js');
            if (!(await Local.isWebGPUAvailable())) throw new Error('Perangkat ini tidak mendukung WebGPU.');
            urls = await Local.generateLocal(prompt, safeW, safeH, statusEl);
          } catch (err) {
            statusEl.textContent = 'Lokal gagal, beralih ke Cloud (Gratis)…';
            urls = await runCloud();
          }
        } else {
          // langsung Cloud
          urls = await runCloud();
        }

        statusEl.textContent = 'Sukses: ' + (urls.length || 0) + ' gambar';
        urls.forEach((url, i)=>{
          const card = document.createElement('div');
          card.className = 'rounded-xl overflow-hidden border border-white/10 bg-slate-900/40 shadow';
          const img = document.createElement('img');
          img.src = url; img.alt = 'hasil'; img.className = 'w-full h-auto block';
          const tools = document.createElement('div');
          tools.className = 'p-3 flex items-center justify-between text-sm';
          tools.innerHTML = `
            <span class="opacity-75">#${i+1} • ${width}×${height} • ${engine}</span>
            <div class="flex gap-2">
              <a class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20" href="${url}" target="_blank" rel="noopener">Buka</a>
              <a class="px-3 py-1.5 rounded-lg bg-gradient-to-br from-brand-400 to-brand-600 text-slate-900 font-semibold" href="${url}" download="mukemen-image-${i+1}.png">Unduh</a>
            </div>`;
          card.appendChild(img); card.appendChild(tools); outEl.appendChild(card);
        });

        // Notif PWA (kalau ada fungsi notifyImageReady di project-mu)
        if (urls.length && typeof notifyImageReady === 'function') {
          notifyImageReady(urls[0], urls.length);
        }
      } catch (e) {
        statusEl.textContent = 'Gagal: ' + e.message;
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
